<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ajuan Nomor Login - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./css/admin.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="logo">Admin Perpustakaan Politeknik Negeri Medan</div>
        <nav>
          <ul>
            <li><a href="./dashboard.html">Dashboard</a></li>
            <li><a href="./books.html">Kelola Buku</a></li>
            <li><a href="./members.html">Kelola Anggota</a></li>
            <li><a href="./loans.html">Kelola Peminjaman</a></li>
            <li><a href="./returns.html">Kelola Pengembalian</a></li>
            <li><a href="./reports.html">Laporan</a></li>
            <li><a class="active" href="./login-requests.html">Ajuan Pengunjung</a></li>
            <li><a href="../admin/login.html">Logout</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1>Ajuan Nomor Login</h1>
            <p class="label">Pantau permohonan nomor login dan proses sesuai kebutuhan.</p>
          </div>
        </div>

        <div id="alertMessage" class="alert" role="alert" style="display: none;"></div>

        <section class="cards" style="margin-bottom: 24px;" id="statsCards">
          <article class="card">
            <span class="label">Total Permohonan</span>
            <h3 id="statTotal">0</h3>
          </article>
          <article class="card">
            <span class="label">Pending</span>
            <h3 id="statPending">0</h3>
          </article>
          <article class="card">
            <span class="label">Disetujui</span>
            <h3 id="statDiterima">0</h3>
          </article>
          <article class="card">
            <span class="label">Ditolak</span>
            <h3 id="statDitolak">0</h3>
          </article>
        </section>

        <section class="card table-card">
          <div class="topbar" style="gap: 16px;">
            <div>
              <h2>Daftar Permohonan</h2>
              <p class="label">Klik update setelah mengubah status atau nomor login.</p>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>NIM</th>
                  <th>Email</th>
                  <th>Prodi</th>
                  <th>Alasan</th>
                  <th>Diajukan</th>
                  <th>Status</th>
                  <th>Nomor Login</th>
                  <th>Tindakan</th>
                </tr>
              </thead>
              <tbody id="requestsTableBody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 24px;">Memuat data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script>
    (function () {
      function showAlert(message, type) {
        const alertEl = document.getElementById('alertMessage');
        alertEl.textContent = message;
        alertEl.className = 'alert alert-' + type;
        alertEl.style.display = 'block';
        setTimeout(() => {
          alertEl.style.display = 'none';
        }, 5000);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
      }

      function updateStats(requests) {
        document.getElementById('statTotal').textContent = requests.length;
        document.getElementById('statPending').textContent = requests.filter(r => r.status === 'pending').length;
        document.getElementById('statDiterima').textContent = requests.filter(r => r.status === 'diterima').length;
        document.getElementById('statDitolak').textContent = requests.filter(r => r.status === 'ditolak').length;
      }

      function loadRequests() {
        fetch('./login-requests-api.php')
          .then(response => response.json())
          .then(data => {
            const tbody = document.getElementById('requestsTableBody');
            
            if (!data.success || data.requests.length === 0) {
              tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 24px;">Belum ada permohonan.</td></tr>';
              updateStats([]);
              return;
            }

            updateStats(data.requests);

            tbody.innerHTML = data.requests.map(request => {
              const loginNumberDisplay = request.login_number 
                ? `<code>${escapeHtml(request.login_number)}</code>` 
                : '<span class="muted">-</span>';
              
              return `
                <tr>
                  <td>${escapeHtml(request.nama)}</td>
                  <td>${escapeHtml(request.nim)}</td>
                  <td>${escapeHtml(request.email)}</td>
                  <td>${escapeHtml(request.prodi)}</td>
                  <td style="max-width: 220px;">${escapeHtml(request.alasan).replace(/\n/g, '<br>')}</td>
                  <td>${formatDate(request.created_at)}</td>
                  <td><span class="status status-${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></td>
                  <td>${loginNumberDisplay}</td>
                  <td>
                    <form class="request-form" onsubmit="updateRequest(event, ${request.id})">
                      <input type="hidden" name="request_id" value="${request.id}" />
                      <select name="status" id="status_${request.id}">
                        <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="diterima" ${request.status === 'diterima' ? 'selected' : ''}>Diterima</option>
                        <option value="ditolak" ${request.status === 'ditolak' ? 'selected' : ''}>Ditolak</option>
                      </select>
                      <input
                        type="text"
                        name="login_number"
                        placeholder="Nomor login"
                        value="${escapeHtml(request.login_number || '')}"
                        id="login_${request.id}"
                      />
                      <button class="btn btn-primary" type="submit">Update</button>
                    </form>
                  </td>
                </tr>
              `;
            }).join('');
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 24px;">Gagal memuat data.</td></tr>';
          });
      }

      window.updateRequest = function(event, requestId) {
        event.preventDefault();
        const form = event.target;
        const status = form.querySelector('select[name="status"]').value;
        const loginNumber = form.querySelector('input[name="login_number"]').value.trim();
        
        const formData = new FormData();
        formData.append('request_id', requestId);
        formData.append('status', status);
        formData.append('login_number', loginNumber);

        fetch('./login-requests-update.php', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showAlert(data.message, 'success');
              loadRequests();
            } else {
              showAlert(data.message, 'danger');
            }
          })
          .catch(error => {
            showAlert('Terjadi kesalahan saat memperbarui permohonan.', 'danger');
          });
      };

      loadRequests();
    })();
  </script>
</html>

