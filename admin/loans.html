<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Peminjaman - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./css/admin.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="logo">Admin Perpustakaan Politeknik Negeri Medan</div>
        <nav>
          <ul>
            <li><a href="./dashboard.html">Dashboard</a></li>
            <li><a href="./books.html">Kelola Buku</a></li>
            <li><a href="./members.html">Kelola Anggota</a></li>
            <li><a class="active" href="./loans.html">Kelola Peminjaman</a></li>
            <li><a href="./returns.html">Kelola Pengembalian</a></li>
            <li><a href="./reports.html">Laporan</a></li>
            <li><a href="./login-requests.html">Ajuan Pengunjung</a></li>
            <li><a href="../admin/login.html">Logout</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1>Kelola Peminjaman</h1>
            <p class="label">Setujui atau tolak permintaan peminjaman</p>
          </div>
        </div>

        <div id="alertMessage" class="alert" role="alert" style="display: none;"></div>

        <section class="card table-card">
          <table>
            <thead>
              <tr>
                <th>Judul Buku</th>
                <th>Nomor Login</th>
                <th>Pengajuan</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="loansTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 24px;">Memuat data...</td>
              </tr>
            </tbody>
          </table>
        </section>
      </main>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script>
    (function () {
      function showAlert(message, type) {
        const alertEl = document.getElementById('alertMessage');
        alertEl.textContent = message;
        alertEl.className = 'alert alert-' + type;
        alertEl.style.display = 'block';
        setTimeout(() => {
          alertEl.style.display = 'none';
        }, 5000);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      }

      function loadLoans() {
        fetch('./loans-api.php')
          .then(response => response.json())
          .then(data => {
            const tbody = document.getElementById('loansTableBody');
            
            if (!data.success || data.requests.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px;">Belum ada permintaan peminjaman.</td></tr>';
              return;
            }

            tbody.innerHTML = data.requests.map(request => {
              return `
                <tr>
                  <td>
                    <strong>${escapeHtml(request.judul)}</strong>
                    <p class="muted" style="margin: 0;">oleh ${escapeHtml(request.penulis)}</p>
                  </td>
                  <td><code>${escapeHtml(request.login_number)}</code></td>
                  <td>${formatDate(request.created_at)}</td>
                  <td><span class="status status-${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span></td>
                  <td>
                    <form class="request-form" onsubmit="updateStatus(event, ${request.id})">
                      <select name="status" id="status_${request.id}">
                        <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="disetujui" ${request.status === 'disetujui' ? 'selected' : ''}>Disetujui</option>
                        <option value="ditolak" ${request.status === 'ditolak' ? 'selected' : ''}>Ditolak</option>
                        <option value="dikembalikan" ${request.status === 'dikembalikan' ? 'selected' : ''}>Dikembalikan</option>
                      </select>
                      <button class="btn btn-primary" type="submit">Update</button>
                    </form>
                  </td>
                </tr>
              `;
            }).join('');
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('loansTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px;">Gagal memuat data.</td></tr>';
          });
      }

      window.updateStatus = function(event, requestId) {
        event.preventDefault();
        const form = event.target;
        const status = form.querySelector('select[name="status"]').value;
        
        const formData = new FormData();
        formData.append('request_id', requestId);
        formData.append('status', status);

        fetch('./loans-update.php', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showAlert(data.message, 'success');
              loadLoans();
            } else {
              showAlert(data.message, 'danger');
            }
          })
          .catch(error => {
            showAlert('Terjadi kesalahan saat memperbarui status.', 'danger');
          });
      };

      loadLoans();
    })();
  </script>
</html>

