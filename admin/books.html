<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Buku - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./css/admin.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="logo">Admin Perpustakaan Politeknik Negeri Medan</div>
        <nav>
          <ul>
            <li><a href="./dashboard.html">Dashboard</a></li>
            <li><a class="active" href="./books.html">Kelola Buku</a></li>
            <li><a href="./members.html">Kelola Anggota</a></li>
            <li><a href="./loans.html">Kelola Peminjaman</a></li>
            <li><a href="./returns.html">Kelola Pengembalian</a></li>
            <li><a href="./reports.html">Laporan</a></li>
            <li><a href="./login-requests.html">Ajuan Pengunjung</a></li>
            <li><a href="../admin/login.html">Logout</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1>Kelola Buku</h1>
            <p class="label">Tambah, ubah, atau hapus koleksi buku</p>
          </div>
          <a class="btn btn-primary" href="./add-book.html">+ Tambah Buku</a>
        </div>

        <div id="statusMessage" class="alert alert-success" role="alert" style="display: none;"></div>

        <section class="card table-card">
          <table>
            <thead>
              <tr>
                <th>Judul</th>
                <th>Penulis</th>
                <th>Tahun</th>
                <th>Kategori</th>
                <th>Stok</th>
                <th>Cover</th>
                <th>Ditambahkan</th>
              </tr>
            </thead>
            <tbody id="booksTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 24px;">Memuat data...</td>
              </tr>
            </tbody>
          </table>
        </section>
      </main>
    </div>
  </body>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <script>
    (function () {
      // Check status message from URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('status') === 'success') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = 'Buku berhasil disimpan.';
        statusEl.style.display = 'block';
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }

      // Load books data
      fetch('./books-api.php')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('booksTableBody');
          
          if (!data.success || data.books.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;">Belum ada data buku. Tambahkan melalui tombol di atas.</td></tr>';
            return;
          }

          tbody.innerHTML = data.books.map(book => {
            const coverLink = book.cover ? `<a href="../${book.cover}" target="_blank">Lihat</a>` : '<span class="muted">-</span>';
            const date = new Date(book.created_at);
            const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            
            return `
              <tr>
                <td>${escapeHtml(book.judul)}</td>
                <td>${escapeHtml(book.penulis)}</td>
                <td>${book.tahun}</td>
                <td>${escapeHtml(book.kategori)}</td>
                <td>${book.stok}</td>
                <td>${coverLink}</td>
                <td>${formattedDate}</td>
              </tr>
            `;
          }).join('');
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('booksTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;">Gagal memuat data.</td></tr>';
        });

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    })();
  </script>
</html>

