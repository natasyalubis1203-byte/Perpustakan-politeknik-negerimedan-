<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Anggota - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./css/admin.css" />
  </head>

  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="logo">Admin Perpustakaan Politeknik Negeri Medan</div>
        <nav>
          <ul>
            <li><a href="./dashboard.html">Dashboard</a></li>
            <li><a href="./books.html">Kelola Buku</a></li>
            <li><a class="active" href="./members.html">Kelola Anggota</a></li>
            <li><a href="./loans.html">Kelola Peminjaman</a></li>
            <li><a href="./returns.html">Kelola Pengembalian</a></li>
            <li><a href="./reports.html">Laporan</a></li>
            <li><a href="./login-requests.html">Ajuan Pengunjung</a></li>
            <li><a href="../admin/login.html">Logout</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h1>Kelola Anggota</h1>
            <p class="label">Daftar anggota perpustakaan</p>
          </div>

          <!-- Button Tambah -->
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTambah">
            + Tambah Anggota
          </button>
        </div>

        <div id="statusMessage" class="alert alert-success" role="alert" style="display: none; margin-bottom: 24px;"></div>

        <section class="card table-card">
          <table>
            <thead>
              <tr>
                <th>Nama</th>
                <th>Username</th>
                <th>Role</th>
                <th>Bergabung</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="membersTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 24px;">Memuat data...</td>
              </tr>
            </tbody>
          </table>
        </section>
      </main>
    </div>

    <!--  MODAL FORM TAMBAH ANGGOTA  -->
    <div class="modal fade" id="modalTambah" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Anggota</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <form action="insert-anggota.php" method="POST">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Nama Lengkap</label>
                <input type="text" name="nama" class="form-control" required placeholder="contoh: Budi Santoso" />
              </div>

              <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" name="username" class="form-control" required placeholder="username unik" />
                <small class="text-muted">Username harus unik dan tidak boleh sama dengan yang sudah ada.</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" name="password" class="form-control" required placeholder="minimal 6 karakter" minlength="6" />
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="submit" class="btn btn-primary">Simpan</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      (function () {
        // Check status message from URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('status') === 'success') {
          const statusEl = document.getElementById('statusMessage');
          statusEl.textContent = 'Anggota berhasil ditambahkan.';
          statusEl.style.display = 'block';
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 5000);
        }

        // Load members data
        fetch('./members-api.php')
          .then(response => response.json())
          .then(data => {
            const tbody = document.getElementById('membersTableBody');
            
            if (!data.success || data.members.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px;">Belum ada anggota terdaftar.</td></tr>';
              return;
            }

            tbody.innerHTML = data.members.map(member => {
              const date = new Date(member.created_at);
              const formattedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
              
              return `
                <tr>
                  <td><strong>${escapeHtml(member.nama)}</strong></td>
                  <td><code>${escapeHtml(member.username)}</code></td>
                  <td><span class="status status-success">${member.role.charAt(0).toUpperCase() + member.role.slice(1)}</span></td>
                  <td>${formattedDate}</td>
                  <td class="actions">
                    <button class="btn btn-outline" style="padding: 4px 12px; font-size: 0.85rem;">Edit</button>
                    <button class="danger" style="padding: 4px 12px; font-size: 0.85rem;">Hapus</button>
                  </td>
                </tr>
              `;
            }).join('');
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('membersTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px;">Gagal memuat data.</td></tr>';
          });

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      })();
    </script>
  </body>
</html>

